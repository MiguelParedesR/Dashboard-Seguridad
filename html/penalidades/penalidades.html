<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Penalidades - TPP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- CSS del m√≥dulo -->
  <link rel="stylesheet" href="../../css/penalidades/penalidades.css" />
  <!-- Supabase (UMD que expone window.supabase) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>

<body>
  <main class="wrap">
    <!-- Panel izquierdo: registro / edici√≥n -->
    <aside class="panel">
      <h1>Penalidades</h1>
      <form id="formPenalidad" class="card">
        <input type="hidden" id="editId" />

        <div class="row">
          <label>Empresa</label>
          <!-- Se mantiene din√°mico (IDs reales) para NO romper el guardado -->
          <select id="empresa" required></select>
        </div>

        <div class="row">
          <label>Local</label>
          <select id="local" required>
            <option value="">Seleccionar...</option>
            <option>TPP1</option>
            <option>TPP2</option>
            <option>TPP3</option>
            <option>TPP4</option>
            <option>TPP4 - ANEXO</option>
          </select>
        </div>

        <!-- TYPEAHEAD de Agente (reemplaza el <select id="agente"> y el toggle manual) -->
        <div class="row" id="agenteTA">
          <label>Agente</label>
          <div style="position:relative; flex:1; min-width:260px;">
            <input
              type="text"
              id="agenteSearch"
              placeholder="Escribe para buscar‚Ä¶ (min. 2 letras)"
              autocomplete="off"
            />
            <input type="hidden" id="agenteId" />
            <!-- dropdown -->
            <div id="taDropdown" class="modal hidden" style="inset:auto; top:unset; left:unset;">
              <div class="modal-box" style="max-width:520px; padding:8px; border-radius:10px;">
                <div id="taList" style="max-height:360px; overflow:auto;"></div>
                <div style="display:flex; justify-content:flex-end; margin-top:8px;">
                  <button type="button" id="taAddBtn" class="ghost">Agregar nuevo</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <label>Penalidad</label>
          <select id="penalidad" required></select>
        </div>

        <div class="row">
          <label>Monto (S/.)</label>
          <input type="text" id="monto" readonly />
        </div>

        <div class="row">
          <label>Observaciones</label>
          <textarea id="observaciones" rows="3" placeholder="(opcional)"></textarea>
        </div>

        <div class="row">
          <label>Fecha</label>
          <!-- Wrapper para estilo minimalista -->
          <div class="date-field fancy-date">
            <span class="date-leading-icon" aria-hidden="true">üìÖ</span>
            <input type="date" id="fecha" />
            <span class="date-trailing-clear" id="fechaClear" title="Limpiar">‚úï</span>
          </div>
        </div>

        <!-- Uploader elegante con previews -->
        <div class="row">
          <label>Evidencias</label>
          <div class="uploader" id="uploader">
            <input type="file" id="evidencias" multiple accept="image/*" />
            <div class="uploader-cta">
              <div class="uploader-icon">‚¨ÜÔ∏è</div>
              <div>
                <strong>Subir im√°genes</strong>
                <div class="muted">Arrastra y suelta o haz clic para seleccionar (hasta 5)</div>
              </div>
            </div>
          </div>
        </div>
        <div id="previewList" class="previews"></div>

        <div class="actions">
          <button type="submit" id="btnGuardar">Aplicar penalidad</button>
          <button type="button" id="btnCancelar" class="secondary hidden">Cancelar edici√≥n</button>
        </div>
      </form>
    </aside>

    <!-- Columna derecha: filtros + resumen + tabla CRUD -->
    <section class="grid">
      <div class="card stretch">
        <div class="toolbar">
          <h2>Registros</h2>
          <div class="filters">
            <!-- Filtro de Empresa FIJO a 2 opciones (evita duplicados); el JS hace fallback por sin√≥nimos -->
            <select id="fEmpresa">
              <option value="">Todas las empresas</option>
              <option value="ui:CORSEPRI S.A.">CORSEPRI S.A.</option>
              <option value="ui:VICMER SECURITY">VICMER SECURITY</option>
            </select>

            <select id="fLocal">
              <option value="">Todos los locales</option>
              <option>TPP1</option>
              <option>TPP2</option>
              <option>TPP3</option>
              <option>TPP4</option>
              <option>TPP4 - ANEXO</option>
            </select>

            <!-- Fechas minimalistas -->
            <div class="date-field fancy-date">
              <span class="date-leading-icon" aria-hidden="true">üìÖ</span>
              <input type="date" id="fDesde" />
              <span class="date-trailing-clear" id="fDesdeClear" title="Limpiar">‚úï</span>
            </div>
            <div class="date-field fancy-date">
              <span class="date-leading-icon" aria-hidden="true">üìÖ</span>
              <input type="date" id="fHasta" />
              <span class="date-trailing-clear" id="fHastaClear" title="Limpiar">‚úï</span>
            </div>

            <!-- Buscador -->
            <div class="search-field">
              <input type="text" id="q" placeholder="Buscar (agente / observaciones)" />
              <span class="search-icon">üîé</span>
            </div>
            <button id="fBuscar" class="ghost">Filtrar</button>
          </div>
        </div>

        <!-- RESUMEN -->
        <div id="summaryBar" class="summary card-ghost hidden">
          <div class="summary-left">
            <div class="kpi">
              <div class="kpi-label">Suma filtrada</div>
              <div class="kpi-value" id="sumMontos">S/ 0.00</div>
            </div>
          </div>
          <div class="summary-right" id="catBadges"><!-- badges por categor√≠a --></div>
        </div>

        <div class="table-wrap">
          <table id="tablaPenalidades">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Empresa</th>
                <th>Local</th>
                <th>Agente</th>
                <th>Penalidad</th>
                <th>Monto (S/.)</th>
                <th style="text-align:center;">Evidencia</th>
                <th style="text-align:center;">Acciones</th>
              </tr>
            </thead>
            <tbody><!-- din√°mico --></tbody>
          </table>
          <div id="emptyState" class="empty hidden">No hay resultados con los filtros aplicados.</div>
        </div>

        <div class="paginator">
          <div class="left">
            <label>Tama√±o de p√°gina</label>
            <select id="pageSize">
              <option>10</option>
              <option selected>20</option>
              <option>50</option>
            </select>
          </div>
          <div class="right">
            <button id="btnPrev" class="ghost">Anterior</button>
            <span id="pageInfo">P√°gina 1</span>
            <button id="btnNext" class="ghost">Siguiente</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal confirmaci√≥n eliminar -->
  <div id="modalDelete" class="modal hidden">
    <div class="modal-box">
      <h3>Eliminar registro</h3>
      <p>¬øEst√°s seguro que deseas eliminar esta penalidad?</p>
      <div class="modal-actions">
        <button id="modalCancel" class="secondary">Cancelar</button>
        <button id="modalOk" class="danger">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Modal galer√≠a evidencias + lightbox -->
  <div id="modalGallery" class="modal hidden">
    <div class="modal-box gallery">
      <div class="gallery-header">
        <h3>Evidencias</h3>
        <button id="galleryClose" class="secondary">Cerrar</button>
      </div>
      <div id="galleryGrid" class="gallery-grid"><!-- thumbs din√°micas --></div>

      <!-- Lightbox interno (zoom) -->
      <div id="lightbox" class="lightbox hidden">
        <div class="lightbox-backdrop"></div>
        <div class="lightbox-content">
          <button id="lightboxClose" class="lightbox-close" title="Cerrar">‚úï</button>
          <img id="lightboxImg" src="" alt="Evidencia ampliada" />
        </div>
      </div>
    </div>
  </div>

  <!-- Modal notificaci√≥n creativa (reemplaza alert) -->
  <div id="notifyModal" class="notify hidden">
    <div class="notify-box">
      <div class="notify-icon" id="notifyIcon">‚úÖ</div>
      <div class="notify-text">
        <div class="notify-title" id="notifyTitle">Hecho</div>
        <div class="notify-msg" id="notifyMsg">Operaci√≥n completada.</div>
      </div>
      <button id="notifyClose" class="notify-close" title="Cerrar">‚úï</button>
    </div>
  </div>

  <!-- Config + Supabase client + JS del m√≥dulo -->
  <script src="../../config.js"></script>
  <script src="../../js/core/supabaseClient.js"></script>
  <script src="../../js/penalidades/penalidades.js"></script>
</body>
</html>
