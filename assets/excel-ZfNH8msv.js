const n=e=>document.querySelector(e),A=e=>Array.from(document.querySelectorAll(e));let w=null;const D="excel";function B(){var e,t,o;return((o=(t=(e=window.CONFIG)==null?void 0:e.SUPABASE)==null?void 0:t.resolveDbKeyForModule)==null?void 0:o.call(t,D))||"PENALIDADES"}async function I(){var t,o;if(w)return w;const e=(o=(t=window.CONFIG)==null?void 0:t.SUPABASE)==null?void 0:o.waitForClient;return typeof e!="function"?null:(w=await e(B()),w)}const H={"CORSEPRI S.A.":"CORSEPRISA","VICMER SECURITY":"VICMER"},q=["CORSEPRI S.A.","VICMER SECURITY"];let f=1,L=20,p=[],u=new Set(["puntual","tardanza","falto"]),C=!1;const X=["Fecha","Turno","Empresa","Local","Agente","Hora de llegada","Horas sin cubrir","Penalidad (S/.)","Observaciones"];function k(){var t,o,a,s,i,l,c,h,r,m,b,S;const e=document.querySelector("main.wrap");e&&e.dataset.excelInit!=="true"&&(e.dataset.excelInit="true",(t=n("#cardAsis"))==null||t.addEventListener("click",()=>x("asis")),(o=n("#cardPen"))==null||o.addEventListener("click",()=>x("pen")),(a=n("#btnBack"))==null||a.addEventListener("click",()=>x("home")),(s=n("#btnAsisLoad"))==null||s.addEventListener("click",Y),(i=n("#btnAsisDownload"))==null||i.addEventListener("click",J),(l=n("#btnPenLoad"))==null||l.addEventListener("click",W),(c=n("#btnPenDownload"))==null||c.addEventListener("click",Q),(h=n("#pageSize"))==null||h.addEventListener("change",()=>{L=parseInt(n("#pageSize").value,10)||20,f=1,E()}),(r=n("#btnPrev"))==null||r.addEventListener("click",()=>{f>1&&(f--,E())}),(m=n("#btnNext"))==null||m.addEventListener("click",()=>{const d=p.length;f*L<d&&(f++,E())}),(b=n("#multiBtn"))==null||b.addEventListener("click",d=>{d.preventDefault(),V()}),document.addEventListener("click",d=>{var g;(g=n("#estadoBox"))!=null&&g.contains(d.target)||G()}),(S=n("#multiMenu"))==null||S.addEventListener("change",K),U(),n("#theadRow").innerHTML=X.map(d=>`<th>${d}</th>`).join(""))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",k):k();document.addEventListener("partial:loaded",k);function x(e){var o,a,s,i,l;if(e==="home"){(o=n("#home"))==null||o.classList.remove("hidden"),(a=n("#view"))==null||a.classList.add("hidden");return}(s=n("#home"))==null||s.classList.add("hidden"),(i=n("#view"))==null||i.classList.remove("hidden");const t=e==="asis";n("#vhTitle").textContent=t?"Reporte Asistencia":"Reporte Penalidades",n("#vhSub").textContent=t?"Tardanzas con penalidad (S/.)":"Penalidades aplicadas (S/.)",n("#kpiVista").textContent=t?"Asistencia":"Penalidades",A(".view-only-asis").forEach(c=>c.classList.toggle("hidden",!t)),A(".view-only-pen").forEach(c=>c.classList.toggle("hidden",t)),(l=n("#estadoBox"))==null||l.classList.toggle("hidden",!t),p=[],f=1,n("#kpiRange").textContent="—",n("#kpiCount").textContent="0",n("#totalMonto").textContent="S/ 0.00",n("#tblPreview tbody").innerHTML="",n("#hint").textContent=t?"Elige el rango de fechas y presiona “Cargar Asistencia” para ver el preview.":"Elige el rango de fechas y presiona “Cargar Penalidades” para ver el preview.",n("#hint").classList.remove("hidden")}function U(){const e=['<option value="">Todas las empresas</option>'].concat(q.map(t=>`<option value="${t}">${t}</option>`)).join("");n("#fEmpresa").innerHTML=e}function R(){const e=n("#fEmpresa").value||null,t=e?H[e]||e:null,o=n("#fLocal").value||null,a=n("#fDesde").value||null,s=n("#fHasta").value||null;return{empresaOrigin:t,local:o,desde:a,hasta:s}}function v(e){n("#loading").hidden=!e}function T(e,t){const o=e||"—",a=t||"—";n("#kpiRange").textContent=`${o} → ${a}`}function j(e){const t=Number(e||0);n("#totalMonto").textContent="S/ "+t.toFixed(2)}function F(e){n("#hint").classList.add("hidden")}function _(e){return(e??"").toString().replace(/[&<>"]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[t])}function N(){const e=new Date,t=o=>String(o).padStart(2,"0");return`${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())}_${t(e.getHours())}-${t(e.getMinutes())}`}function V(){C=!C,n("#multiMenu").hidden=!C}function G(){C=!1,n("#multiMenu").hidden=!0}function K(e){const t=e.target;if(t&&t.type==="checkbox"){const o=t.getAttribute("data-state");if(o==="all"){const a=t.checked;A('#multiMenu input[type="checkbox"]').forEach(s=>{s!==t&&(s.checked=a)}),u=a?new Set(["puntual","tardanza","falto"]):new Set}else{t.checked?u.add(o):u.delete(o);const a=n('#multiMenu input[data-state="all"]'),s=["puntual","tardanza","falto"].every(i=>u.has(i));a.checked=s}u.size===3?n("#multiBadge").textContent="Todos":u.size===0?n("#multiBadge").textContent="Ninguno":n("#multiBadge").textContent=Array.from(u).join(", ")}}async function Y(){try{const e=await I();if(!e){v(!1),console.warn("excel.js: supabase client no disponible para asistencia");return}const{empresaOrigin:t,local:o,desde:a,hasta:s}=R();T(a,s),v(!0);let i=e.from("asistencias_dashboard_ext").select("fecha,turno,empresa,local,agente,hora_llegada,horas_sin_cubrir,penalidad_monto,observaciones");t&&(i=i.eq("empresa",t)),o&&(i=i.eq("local",o)),a&&(i=i.gte("fecha",a)),s&&(i=i.lte("fecha",s));const{data:l,error:c}=await i.limit(5e3);if(c)throw c;let h=l||[];h=h.filter(r=>{const m=(r.observaciones||"").toLowerCase(),b=Number(r.penalidad_monto)>0||/penalidad/i.test(m)||/tardanza/i.test(m),S=Number(r.penalidad_monto)===0&&(r.horas_sin_cubrir==="00:00"||/puntual/i.test(m)),d=/falto/i.test(m);let g=!1;return b&&u.has("tardanza")&&(g=!0),S&&u.has("puntual")&&(g=!0),d&&u.has("falto")&&(g=!0),u.size===3&&(g=!0),g}),p=h,f=1,E(),F(!1),v(!1)}catch(e){console.error("Asistencia load error",e),v(!1)}}async function W(){try{const e=await I();if(!e){v(!1),console.warn("excel.js: supabase client no disponible para penalidades");return}const{empresaOrigin:t,local:o,desde:a,hasta:s}=R();T(a,s),v(!0);let i=e.from("penalidades_aplicadas").select(`
        fecha,
        local,
        observaciones,
        monto_calculado,
        agente_nombre_manual,
        empresas ( nombre ),
        agentes_seguridad ( nombre ),
        penalidades_catalogo ( item, penalidad_nombre )
      `).order("fecha",{ascending:!1});o&&(i=i.eq("local",o)),a&&(i=i.gte("fecha",a)),s&&(i=i.lte("fecha",s));const{data:l,error:c}=await i.limit(5e3);if(c)throw c;let h=(l||[]).filter(r=>{var b;return t?(((b=r.empresas)==null?void 0:b.nombre)||null)===t:!0});h=h.map(r=>{var y,P,M,$;const m=((y=r.empresas)==null?void 0:y.nombre)||"",b=((P=r.agentes_seguridad)==null?void 0:P.nombre)||r.agente_nombre_manual||"(sin nombre)",S=(M=r.penalidades_catalogo)==null?void 0:M.item,d=($=r.penalidades_catalogo)==null?void 0:$.penalidad_nombre,g=d?`${S}. ${d}`:r.observaciones||"";return{fecha:(r.fecha||"").slice(0,10),turno:"",empresa:m,local:r.local||"",agente:b,hora_llegada:"",horas_sin_cubrir:"",penalidad_monto:Number(r.monto_calculado||0),observaciones:g}}),p=h,f=1,E(),F(!1),v(!1)}catch(e){console.error("Penalidades load error",e),v(!1)}}function E(){const e=n("#tblPreview tbody");e.innerHTML="";const t=p.length;n("#kpiCount").textContent=String(t);const o=(f-1)*L,a=Math.min(o+L,t),s=p.slice(o,a);e.innerHTML=s.map(l=>{const c=Number(l.penalidad_monto||0);return`<tr>
      <td>${_(l.fecha)}</td>
      <td>${_(l.turno)}</td>
      <td>${_(l.empresa)}</td>
      <td>${_(l.local)}</td>
      <td>${_(l.agente)}</td>
      <td>${_(l.hora_llegada)}</td>
      <td>${_(l.horas_sin_cubrir)}</td>
      <td>S/ ${c.toFixed(2)}</td>
      <td>${_(l.observaciones)}</td>
    </tr>`}).join("");const i=p.reduce((l,c)=>l+Number(c.penalidad_monto||0),0);j(i),n("#btnPrev").disabled=f===1,n("#btnNext").disabled=f*L>=t}function O(){const e=X.slice(),t=p.map(a=>[a.fecha,a.turno,a.empresa,a.local,a.agente,a.hora_llegada,a.horas_sin_cubrir,Number(a.penalidad_monto||0),a.observaciones]),o=p.reduce((a,s)=>a+Number(s.penalidad_monto||0),0);return t.push([]),t.push(["TOTALES","","","","","","",o,""]),{header:e,body:t}}function z(e,t){const o=XLSX.utils.decode_range(e["!ref"]);for(let s=o.s.c;s<=o.e.c;++s){const i=XLSX.utils.encode_cell({r:0,c:s});e[i]&&(e[i].s={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"2563EB"}},alignment:{horizontal:"center",vertical:"center"},border:{bottom:{style:"thin",color:{rgb:"E5E7EB"}}}})}const a=new Array(t).fill({wch:18});e["!cols"]=a}function J(){if(p.length===0)return;const e=XLSX.utils.book_new(),{header:t,body:o}=O(),a=[t,...o],s=XLSX.utils.aoa_to_sheet(a);z(s,t.length),XLSX.utils.book_append_sheet(e,s,"Asistencia"),XLSX.writeFile(e,`Asistencia_${N()}.xlsx`)}function Q(){if(p.length===0)return;const e=XLSX.utils.book_new(),{header:t,body:o}=O(),a=[t,...o],s=XLSX.utils.aoa_to_sheet(a);z(s,t.length),XLSX.utils.book_append_sheet(e,s,"Penalidades"),XLSX.writeFile(e,`Penalidades_${N()}.xlsx`)}
