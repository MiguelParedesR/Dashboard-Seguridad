(()=>{const b=["LCL","REEFERS","LLENOS","MAQUINARIAS","TRANSPORTES","VACIOS"],I=["TPP1","TPP2","TPP3","TPP4"],C={LIBRE:{label:"Libre",color:"#1f9f6a",text:"#ffffff",icon:"fa-lock-open",hint:"Disponible"},OCUPADO:{label:"Asignado",color:"#e3b63d",text:"#3a2a00",icon:"fa-lock",hint:"Asignado"},SE_DESCONOCE:{label:"Se desconoce",color:"#7c58e3",text:"#ffffff",icon:"fa-circle-question",hint:"Sin dato"},MANTENIMIENTO:{label:"Mantenimiento",color:"#2f80d3",text:"#ffffff",icon:"fa-screwdriver-wrench",hint:"Revision"},BLOQUEADO:{label:"Bloqueado",color:"#e03a3a",text:"#ffffff",icon:"fa-ban",hint:"No disponible"}},U=["LIBRE","OCUPADO","SE_DESCONOCE","MANTENIMIENTO"],V=40,pe=20,me=520,j="lockers:collapsed",W="lockers:view-mode",he=140,Se=80,o={lockers:[],selectedId:null,filters:{search:"",estado:"ALL",local:""},initialLocal:"",localManual:!1,viewMode:"assignments",channel:null,active:!1,loading:!1,loadingColumns:new Set,updatedIds:new Set,updateTimers:new Map,virtualization:{enabled:!1,limits:{}},collapsedStates:{},quickMenu:{open:!1,lockerId:null},isCompact:!1,panelLocked:!1,suppressClick:!1,touchStart:null};let n={},X=null,O=null,_=!1;const ge="lockers";function J(){var e,t,a;return((a=(t=(e=window.CONFIG)==null?void 0:e.SUPABASE)==null?void 0:t.resolveDbKeyForModule)==null?void 0:a.call(t,ge))||"LOCKERS"}function Ce(){var t,a,l;const e=J();return((l=(a=(t=window.CONFIG)==null?void 0:t.SUPABASE)==null?void 0:a.getClient)==null?void 0:l.call(a,e))||null}function ke(e=40,t=250){var s,c;const a=J(),l=(c=(s=window.CONFIG)==null?void 0:s.SUPABASE)==null?void 0:c.waitForClient;return typeof l!="function"?Promise.resolve(null):l(a,{maxAttempts:e,waitMs:t})}function g(e){if(!e)return"LIBRE";const t=String(e).trim().toUpperCase().replace(/\s+/g,"_");return t==="ASIGNADO"?"OCUPADO":t==="DESCONOCIDO"||t==="SE_DESCONOCE"||t==="SE_DESCONOCIDO"?"SE_DESCONOCE":t}function L(e){return e?String(e).trim().toUpperCase():""}function m(e){return e?String(e).trim().toUpperCase():""}function z(e){const t=g(e);return C[t]||C.LIBRE}function Le(){try{const e=localStorage.getItem(j);if(!e)return{};const t=JSON.parse(e);return t&&typeof t=="object"?t:{}}catch{return{}}}function Ee(){try{localStorage.setItem(j,JSON.stringify(o.collapsedStates))}catch{}}function be(){try{return localStorage.getItem(W)||""}catch{return""}}function ye(e){try{localStorage.setItem(W,e)}catch{}}function Z(e,t){if(!e)return`rgba(255, 255, 255, ${t})`;const a=e.replace("#","");if(a.length!==6)return`rgba(255, 255, 255, ${t})`;const l=parseInt(a.slice(0,2),16),s=parseInt(a.slice(2,4),16),c=parseInt(a.slice(4,6),16);return`rgba(${l}, ${s}, ${c}, ${t})`}function ee(e){var t;o.isCompact!==e&&(o.isCompact=e,(t=n.root)==null||t.classList.toggle("is-compact",e))}function te(){_||(_=!0,window.requestAnimationFrame(()=>{if(!o.active||!n.root){_=!1;return}const e=window.scrollY||document.documentElement.scrollTop||0;!o.isCompact&&e>he?ee(!0):o.isCompact&&e<Se&&ee(!1),_=!1}))}function h(e,t="info"){n.status&&(n.status.textContent=e,n.status.classList.remove("success","error","warn"),t==="success"&&n.status.classList.add("success"),t==="error"&&n.status.classList.add("error"),t==="warn"&&n.status.classList.add("warn")),t!=="info"&&ve(e,t)}function ve(e,t){n.toast&&(n.toast.textContent=e,n.toast.classList.remove("success","error","warn"),t&&n.toast.classList.add(t),n.toast.classList.add("is-visible"),clearTimeout(n.toastTimer),n.toastTimer=setTimeout(()=>{n.toast.classList.remove("is-visible")},2400))}function q(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")}function ae(e,t){const a=String(e||""),l=String(t||"").trim().toLowerCase();if(!l)return q(a);const c=a.toLowerCase().indexOf(l);if(c===-1)return q(a);const r=q(a.slice(0,c)),i=q(a.slice(c,c+l.length)),d=q(a.slice(c+l.length));return`${r}<mark>${i}</mark>${d}`}function E(){const e=o.lockers.find(a=>a.id===o.selectedId)||null;if(!e)return null;const t=m(o.filters.local);return t&&t!=="ALL"&&m(e.local)!==t?null:e}function P(e,t={}){const a=t.search!==void 0?t.search:o.filters.search,l=String(a||"").trim().toLowerCase(),s=t.estado!==void 0?t.estado:o.filters.estado,c=t.local!==void 0?t.local:o.filters.local,r=m(c);return e.filter(i=>i.activo===!1||r&&r!=="ALL"&&m(i.local)!==r||s!=="ALL"&&g(i.estado)!==s?!1:l?[i.codigo,i.colaborador_nombre].filter(Boolean).map(u=>String(u).toLowerCase()).join(" ").includes(l):!0)}function H(e){return e.slice().sort((t,a)=>String(t.codigo||"").localeCompare(String(a.codigo||""),"es",{numeric:!0,sensitivity:"base"}))}function ne(e){const t=new Set;e.forEach(l=>{const s=L(l.area);s&&t.add(s)});const a=Array.from(t).filter(l=>!b.includes(l)).sort();return[...b,...a]}function oe(e){const t=new Set,a=[];e.forEach(s=>{const c=m(s);!c||t.has(c)||t.add(c)}),I.forEach(s=>{t.has(s)&&(a.push(s),t.delete(s))});const l=Array.from(t).sort();return[...a,...l]}function $(e){const t=[];return e.forEach(a=>{const l=m(a.local);l&&t.push(l)}),oe([...I,...t])}function we(e){const t=[];return e.forEach(a=>{const l=m(a.local);l&&t.push(l)}),oe(t)}function y(e){if(!n.areaSelect)return;const t=ne(e),a=n.areaSelect.value;n.areaSelect.innerHTML="",t.forEach(l=>{const s=document.createElement("option");s.value=l,s.textContent=l,n.areaSelect.appendChild(s)}),a&&(n.areaSelect.value=a)}function v(e){if(!n.localSelect)return;const t=$(e),a=n.localSelect.value;n.localSelect.innerHTML="",t.forEach(l=>{const s=document.createElement("option");s.value=l,s.textContent=l,n.localSelect.appendChild(s)}),a?n.localSelect.value=a:o.filters.local&&(n.localSelect.value=o.filters.local)}function Ae(){try{const e=new URL(window.location.href),t=e.searchParams.get("local");if(t)return t;if(e.hash){const a=e.hash.replace("#","");return!a||a.startsWith("/")||a.includes("/")?"":a}}catch{return""}return""}function Te(){const e=we(o.lockers),t=$(o.lockers),a=m(o.filters.local),l=m(o.initialLocal);if(l&&t.includes(l)){o.filters.local=l,o.initialLocal="";return}if(!a){o.filters.local=e[0]||t[0]||"";return}!o.localManual&&e.length&&!e.includes(a)&&(o.filters.local=e[0])}function Ie(e){try{const t=new URL(window.location.href);e?t.searchParams.set("local",e):t.searchParams.delete("local");const a=`${t.pathname}${t.search}${t.hash}`,l=Object.assign({},history.state||{});history.replaceState(l,"",a)}catch{}}function Oe(e,t={}){const a=m(e);if(!a||o.filters.local===a)return;o.filters.local=a,o.localManual=!0;const l=E();l&&m(l.local)!==a&&(o.selectedId=null,o.panelLocked=!1),t.updateUrl!==!1&&Ie(a),S()}function Q(){if(!n.root)return;const e=o.viewMode==="assignments";n.root.classList.toggle("view-assignments",e),n.root.classList.toggle("view-states",!e),n.viewToggles&&n.viewToggles.forEach(t=>{const a=t.dataset.view===o.viewMode;t.classList.toggle("is-active",a),t.setAttribute("aria-pressed",a?"true":"false")})}function qe(e,t={}){!e||e!=="assignments"&&e!=="states"||(o.viewMode=e,t.persist!==!1&&ye(e),Q())}function Ne(){if(!n.localTabs)return;const e=$(o.lockers);n.localTabs.innerHTML="",e.forEach(t=>{const a=document.createElement("button");a.type="button",a.className="local-tab",a.dataset.local=t,a.textContent=t;const l=m(o.filters.local)===t;a.classList.toggle("is-active",l),a.setAttribute("aria-pressed",l?"true":"false"),n.localTabs.appendChild(a)}),n.localLabel&&(n.localLabel.textContent=o.filters.local||"--")}function xe(e){const t=z(e.estado),a=document.createElement("button");a.type="button",a.className="area-row",a.dataset.id=e.id,a.style.setProperty("--state-color",e.color_estado||t.color),a.style.setProperty("--state-ink",t.text);const l=document.createElement("div");l.className="area-row-main";const s=document.createElement("div");s.className="area-row-name",s.textContent=e.colaborador_nombre||"Sin asignacion";const c=document.createElement("div");c.className="area-row-code",c.textContent=e.codigo||"--",l.appendChild(s),l.appendChild(c);const r=document.createElement("div");r.className="area-row-meta";const i=document.createElement("div");i.className="area-row-state",i.textContent=t.label;const d=document.createElement("div");d.className="area-row-indicators";const u=document.createElement("span");u.className="area-indicator",e.tiene_candado&&u.classList.add("is-on"),u.title=e.tiene_candado?"Tiene candado":"Sin candado";const f=document.createElement("i");f.className="fa-solid fa-lock",f.setAttribute("aria-hidden","true"),u.appendChild(f);const p=document.createElement("span");p.className="area-indicator",e.tiene_duplicado_llave&&p.classList.add("is-on"),p.title=e.tiene_duplicado_llave?"Tiene duplicado":"Sin duplicado";const A=document.createElement("i");A.className="fa-solid fa-key",A.setAttribute("aria-hidden","true"),p.appendChild(A),d.appendChild(u),d.appendChild(p),r.appendChild(i),r.appendChild(d),a.appendChild(l),a.appendChild(r);const x=[e.colaborador_nombre||"Sin asignacion",e.codigo||"--",t.label];return a.setAttribute("aria-label",x.join(" - ")),a}function Be(){if(!n.areaListView)return;const e=P(o.lockers,{estado:"ALL"}),t=e.filter(s=>s.colaborador_nombre),a=ne(e);n.areaListView.innerHTML="";let l=0;if(a.forEach(s=>{const c=document.createElement("section");c.className="area-list-group";const r=document.createElement("div");r.className="area-list-header";const i=document.createElement("div");i.className="area-list-title",i.textContent=s;const d=document.createElement("div");d.className="area-list-rows";const u=H(t.filter(p=>L(p.area)===s));if(!u.length)return;u.forEach(p=>d.appendChild(xe(p)));const f=document.createElement("div");f.className="area-list-count",f.textContent=`${u.length}`,r.appendChild(i),r.appendChild(f),c.appendChild(r),c.appendChild(d),n.areaListView.appendChild(c),l+=1}),!l){const s=document.createElement("div");s.className="area-empty",s.textContent="Sin asignaciones en este local.",n.areaListView.appendChild(s)}}function Me(){const e=P(o.lockers,{estado:"ALL"}),t={TOTAL:e.length,LIBRE:0,SE_DESCONOCE:0,OCUPADO:0,MANTENIMIENTO:0};e.forEach(a=>{const l=g(a.estado);t[l]!==void 0&&(t[l]+=1)}),n.totalCount&&(n.totalCount.textContent=t.TOTAL),n.assignedCount&&(n.assignedCount.textContent=t.OCUPADO),n.freeCount&&(n.freeCount.textContent=t.LIBRE),n.unknownCount&&(n.unknownCount.textContent=t.SE_DESCONOCE),n.maintenanceCount&&(n.maintenanceCount.textContent=t.MANTENIMIENTO)}function _e(){n.legendChips&&n.legendChips.forEach(e=>{const t=e.dataset.estado||"ALL",a=t==="ALL"&&o.filters.estado==="ALL"||t===o.filters.estado;e.classList.toggle("is-active",a),e.setAttribute("aria-pressed",a?"true":"false")})}function Pe(e){const t=new Map;return U.forEach(a=>t.set(a,[])),e.forEach(a=>{const l=g(a.estado);t.has(l)||t.set(l,[]),t.get(l).push(a)}),t}function D(){o.virtualization.enabled=o.lockers.length>100,o.virtualization.limits={},o.virtualization.enabled&&U.forEach(e=>{o.virtualization.limits[e]=V})}function De(e,t){if(!o.virtualization.enabled)return t;const a=o.virtualization.limits[e]||V;return t.slice(0,a)}function Re(){if(!n.columnsContainer)return{};const e={};return n.columnsContainer.querySelectorAll(".status-column").forEach(t=>{const a=t.dataset.estado,l=t.querySelector(".status-scroll");a&&l&&(e[a]=l.scrollTop)}),e}function Ue(e){n.columnsContainer&&n.columnsContainer.querySelectorAll(".status-column").forEach(t=>{const a=t.dataset.estado,l=t.querySelector(".status-scroll");a&&l&&e[a]!==void 0&&(l.scrollTop=e[a])})}function Ve(e){const t=C[e],a=document.createElement("section");a.className="status-column",a.dataset.estado=e,a.style.setProperty("--state-color",t.color),a.style.setProperty("--state-ink",t.text),a.style.setProperty("--state-tint",Z(t.color,.08));const l=document.createElement("div");l.className="status-column-header";const s=document.createElement("div");s.className="status-title";const c=document.createElement("span");c.className="status-dot";const r=document.createElement("span");r.textContent=t.label,s.appendChild(c),s.appendChild(r);const i=document.createElement("span");i.className="status-count",i.textContent="--",l.appendChild(s),l.appendChild(i);const d=document.createElement("div");d.className="status-scroll";const u=document.createElement("div");u.className="status-list";for(let f=0;f<4;f+=1){const p=document.createElement("div");p.className="skeleton-card",u.appendChild(p)}return d.appendChild(u),a.appendChild(l),a.appendChild(d),a}function ze(e,t){const a=C[e],l=!!o.collapsedStates[e],s=document.createElement("section");s.className="status-column",s.dataset.estado=e,s.dataset.total=String(t.length),s.style.setProperty("--state-color",a.color),s.style.setProperty("--state-ink",a.text),s.style.setProperty("--state-tint",Z(a.color,.08)),s.classList.toggle("is-collapsed",l),o.loadingColumns.has(e)&&s.classList.add("is-loading");const c=document.createElement("div");c.className="status-column-header";const r=document.createElement("div");r.className="status-title";const i=document.createElement("span");i.className="status-dot";const d=document.createElement("span");d.textContent=a.label,r.appendChild(i),r.appendChild(d);const u=document.createElement("span");u.className="status-count",u.textContent=`${t.length}`;const f=document.createElement("div");f.className="status-actions";const p=document.createElement("button");p.type="button",p.className="column-toggle",p.dataset.estado=e,p.setAttribute("aria-expanded",l?"false":"true"),p.setAttribute("aria-label",l?"Expandir columna":"Colapsar columna");const A=document.createElement("span");if(A.textContent=">",p.appendChild(A),f.appendChild(u),f.appendChild(p),c.appendChild(r),c.appendChild(f),l)return s.appendChild(c),s;const x=document.createElement("div");x.className="status-scroll";const B=document.createElement("div");if(B.className="status-list",t.length){const T=H(t),fe=De(e,T);if(fe.forEach(M=>B.appendChild(He(M))),o.virtualization.enabled&&T.length>fe.length){const M=document.createElement("div");M.className="empty-state",M.textContent="Desliza para cargar mas",B.appendChild(M)}}else{const T=document.createElement("div");T.className="empty-state",T.textContent="Sin lockers en este estado.",B.appendChild(T)}return x.appendChild(B),s.appendChild(c),s.appendChild(x),s}function He(e){const t=z(e.estado),a=String(o.filters.search||"").trim(),l=g(e.estado),s=document.createElement("button");s.type="button",s.className="locker-card",s.dataset.id=e.id,s.dataset.estado=l,s.style.setProperty("--state-color",e.color_estado||t.color),s.style.setProperty("--state-ink",t.text),e.id===o.selectedId&&s.classList.add("is-selected"),o.updatedIds.has(e.id)&&s.classList.add("is-updated");const c=document.createElement("div");c.className="card-state",c.textContent=t.label;const r=document.createElement("div");r.className="card-code",r.innerHTML=ae(e.codigo||"--",a);const i=document.createElement("div");i.className="card-assignee",e.colaborador_nombre?i.innerHTML=ae(e.colaborador_nombre,a):(i.textContent=t.hint,i.classList.add("is-muted"));const d=document.createElement("div");d.className="card-icon";const u=document.createElement("i"),f=e.icono_estado||t.icon;u.className=`fa-solid ${f}`,u.setAttribute("aria-hidden","true"),d.appendChild(u),s.appendChild(c),s.appendChild(r),s.appendChild(i),s.appendChild(d);const p=[e.codigo||"--",t.label];return e.colaborador_nombre&&p.push(e.colaborador_nombre),s.setAttribute("aria-label",p.join(" - ")),s.setAttribute("aria-pressed",e.id===o.selectedId?"true":"false"),s}function k(){if(!n.columnsContainer)return;const e=P(o.lockers),t=Re(),a=U,l=e.filter(c=>a.includes(g(c.estado))).length;if(n.mapCount&&(n.mapCount.textContent=`${l} lockers`),n.columnsContainer.innerHTML="",n.columnsContainer.setAttribute("aria-busy",o.loading?"true":"false"),o.loading){a.forEach(c=>{n.columnsContainer.appendChild(Ve(c))});return}const s=Pe(e);a.forEach(c=>{const r=s.get(c)||[];n.columnsContainer.appendChild(ze(c,r))}),Ue(t),st()}function le(){var l;const e=E(),t=!!e;if(n.panelTitle&&(n.panelTitle.textContent="Detalle del locker"),n.selectedHint.textContent=t?"Edita la ficha o ejecuta una accion rapida.":"Selecciona un locker del mapa.",n.assignBtn.disabled=!t,n.releaseBtn.disabled=!t,n.blockBtn.disabled=!t,n.nameInput.disabled=!t,n.dateInput.disabled=!t,n.areaSelect.disabled=!t,n.localSelect.disabled=!t,n.hasPadlock.disabled=!t,n.hasDuplicateKey.disabled=!t,re(t&&!o.panelLocked),!t){n.selectedCode.textContent="--",n.nameInput.value="",n.dateInput.value="",n.hasPadlock.checked=!1,n.hasDuplicateKey.checked=!1,n.localSelect&&(n.localSelect.value=o.filters.local||((l=n.localSelect.options[0])==null?void 0:l.value)||""),n.selectedStateBadge.style.setProperty("--state-color","#9ca3af"),n.selectedStateBadge.style.setProperty("--state-ink","#ffffff"),n.selectedStateLabel.textContent="Sin seleccion",n.assignBtn.textContent="Asignar",n.releaseBtn.textContent="Liberar",n.blockBtn.textContent="Bloquear",n.assignBtn.classList.remove("is-primary"),n.releaseBtn.classList.remove("is-primary"),n.blockBtn.classList.remove("is-primary");return}const a=z(e.estado);n.selectedCode.textContent=e.codigo||"--",n.nameInput.value=e.colaborador_nombre||"",n.dateInput.value=e.fecha_asignacion||"",e.area?n.areaSelect.value=L(e.area):n.areaSelect.options.length&&(n.areaSelect.value=n.areaSelect.options[0].value),e.local?n.localSelect.value=m(e.local):o.filters.local?n.localSelect.value=o.filters.local:n.localSelect.options.length&&(n.localSelect.value=n.localSelect.options[0].value),n.hasPadlock.checked=!!e.tiene_candado,n.hasDuplicateKey.checked=!!e.tiene_duplicado_llave,n.selectedStateBadge.style.setProperty("--state-color",e.color_estado||a.color),n.selectedStateBadge.style.setProperty("--state-ink",a.text),n.selectedStateLabel.textContent=a.label,$e(e)}function $e(e){const t=g(e.estado);let a="assign";t==="OCUPADO"&&(a="release"),t==="BLOQUEADO"&&(a="block"),t==="MANTENIMIENTO"&&(a="release"),n.assignBtn.classList.toggle("is-primary",a==="assign"),n.releaseBtn.classList.toggle("is-primary",a==="release"),n.blockBtn.classList.toggle("is-primary",a==="block"),n.assignBtn.textContent=t==="SE_DESCONOCE"?"Regularizar":"Asignar",n.blockBtn.textContent=t==="BLOQUEADO"?"Desbloquear":"Bloquear"}function S(){Te(),Ne(),Q(),Be(),Me(),k(),le(),_e()}function F(e){if(!e)return;o.updatedIds.add(e),clearTimeout(o.updateTimers.get(e));const t=setTimeout(()=>{o.updatedIds.delete(e),o.updateTimers.delete(e),k()},1500);o.updateTimers.set(e,t)}async function R(e,t,a){const l=o.lockers.find(f=>f.id===e),s=l?g(l.estado):null,c=t.estado?g(t.estado):s;o.loadingColumns=new Set([s,c].filter(Boolean)),k();const r=Ce();if(!r)return h("Supabase no esta disponible.","error"),o.loadingColumns=new Set,k(),null;h("Guardando cambios...","info");const{data:i,error:d}=await r.from("lockers").update(t).eq("id",e).select("*").single();if(d)return h(`Error al guardar: ${d.message||d}`,"error"),o.loadingColumns=new Set,k(),null;const u=o.lockers.findIndex(f=>f.id===e);return u>=0?o.lockers[u]=i:o.lockers.push(i),y(o.lockers),v(o.lockers),F(e),o.loadingColumns=new Set,S(),h(a||"Locker actualizado.","success"),i}async function Qe(){const e=E();if(!e){h("Selecciona un locker para continuar.","warn");return}const t=n.nameInput.value.trim();if(!t){h("Ingresa un nombre para asignar.","warn"),n.nameInput.focus();return}const a=n.dateInput.value||new Date().toISOString().slice(0,10),l=n.areaSelect.value||L(e.area)||b[0],s=m(n.localSelect.value)||m(e.local)||o.filters.local||I[0],c=C.OCUPADO,r={area:l,local:s,updated_at:new Date().toISOString(),colaborador_nombre:t,fecha_asignacion:a||null,estado:"OCUPADO",color_estado:c.color,icono_estado:c.icon,tiene_candado:n.hasPadlock.checked,tiene_duplicado_llave:n.hasDuplicateKey.checked};await R(e.id,r,"Locker asignado.")}async function se(){const e=E();if(!e){h("Selecciona un locker para continuar.","warn");return}const t=C.LIBRE,a=m(n.localSelect.value)||m(e.local)||o.filters.local||I[0],l={colaborador_nombre:null,fecha_asignacion:null,estado:"LIBRE",color_estado:t.color,icono_estado:t.icon,area:n.areaSelect.value||L(e.area)||b[0],local:a,tiene_candado:!1,tiene_duplicado_llave:!1,updated_at:new Date().toISOString()};await R(e.id,l,"Locker liberado.")}async function ce(){const e=E();if(!e){h("Selecciona un locker para continuar.","warn");return}const t=m(n.localSelect.value)||m(e.local)||o.filters.local||I[0];if(g(e.estado)==="BLOQUEADO"){const c=e.colaborador_nombre?"OCUPADO":"LIBRE",r=C[c]||C.LIBRE,i={estado:c,color_estado:r.color,icono_estado:r.icon,area:n.areaSelect.value||L(e.area)||b[0],local:t,updated_at:new Date().toISOString()};e.colaborador_nombre||(i.colaborador_nombre=null,i.fecha_asignacion=null),await R(e.id,i,"Locker desbloqueado.");return}const l=C.BLOQUEADO,s={estado:"BLOQUEADO",color_estado:l.color,icono_estado:l.icon,area:n.areaSelect.value||L(e.area)||b[0],local:t,updated_at:new Date().toISOString()};await R(e.id,s,"Locker bloqueado.")}function re(e){var t,a;n.root&&(n.root.classList.toggle("panel-open",e),(t=n.panel)==null||t.setAttribute("aria-hidden",e?"false":"true"),(a=n.panelBackdrop)==null||a.setAttribute("aria-hidden",e?"false":"true"))}function Fe(e){const t=e.target.closest(".local-tab");t&&Oe(t.dataset.local)}function Ge(e){const t=e.target.closest(".view-tab");t&&(qe(t.dataset.view),S())}function ie(e){const t=e.target.closest(".area-item, .area-row");t&&(o.panelLocked=!1,o.selectedId=t.dataset.id,w(),S())}function Ye(e){!e||e==="ALL"?o.filters.estado="ALL":o.filters.estado=o.filters.estado===e?"ALL":e,S()}function Ke(e){const t=e.target.closest(".column-toggle");if(!t)return;e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const a=t.dataset.estado;a&&(o.collapsedStates[a]=!o.collapsedStates[a],Ee(),k())}function je(e){if(o.suppressClick){o.suppressClick=!1;return}const t=e.target.closest(".locker-card");t&&(o.panelLocked=!1,o.selectedId=t.dataset.id,w(),S())}function We(e){const t=e.target.closest(".locker-card");t&&(e.pointerType==="mouse"&&e.button!==0||(clearTimeout(O),O=setTimeout(()=>{o.suppressClick=!0,o.selectedId=t.dataset.id,Ze(t.dataset.id,e),k()},me)))}function Xe(){O&&(clearTimeout(O),O=null)}function G(){Xe()}function Je(e){if(!["ArrowDown","ArrowUp","ArrowLeft","ArrowRight"].includes(e.key))return;const a=e.target.closest(".locker-card");if(!a)return;const l=a.closest(".status-column");if(!l)return;const s=Array.from(n.columnsContainer.querySelectorAll(".status-column")),c=s.indexOf(l),r=Array.from(l.querySelectorAll(".locker-card")),i=r.indexOf(a);let d=null;if(e.key==="ArrowDown"&&(d=r[i+1]||r[i]),e.key==="ArrowUp"&&(d=r[i-1]||r[i]),e.key==="ArrowRight"){const u=s[c+1];if(u){const f=Array.from(u.querySelectorAll(".locker-card"));d=f[Math.min(i,f.length-1)]||f[0]}}if(e.key==="ArrowLeft"){const u=s[c-1];if(u){const f=Array.from(u.querySelectorAll(".locker-card"));d=f[Math.min(i,f.length-1)]||f[0]}}d&&(e.preventDefault(),d.focus())}function Ze(e,t){if(!n.quickMenu)return;o.quickMenu.open=!0,o.quickMenu.lockerId=e,o.panelLocked=!0,re(!1);const a=E();if(a){const c=g(a.estado);n.quickAssign.textContent=c==="SE_DESCONOCE"?"Regularizar":"Asignar",n.quickBlock.textContent=c==="BLOQUEADO"?"Desbloquear":"Bloquear"}const l=(t==null?void 0:t.clientX)||window.innerWidth/2,s=(t==null?void 0:t.clientY)||window.innerHeight/2;n.quickMenu.style.setProperty("--menu-x",`${l}px`),n.quickMenu.style.setProperty("--menu-y",`${s}px`),n.quickMenu.classList.add("is-open"),n.quickMenu.setAttribute("aria-hidden","false")}function w(){n.quickMenu&&(o.quickMenu.open=!1,n.quickMenu.classList.remove("is-open"),n.quickMenu.setAttribute("aria-hidden","true"))}function et(){var e;w(),o.panelLocked=!1,le(),(e=n.nameInput)==null||e.focus()}function tt(){w(),o.panelLocked=!1,se()}function at(){w(),o.panelLocked=!1,ce()}function Y(){o.selectedId=null,o.panelLocked=!1,S()}function nt(e){const t=e.target.value.trim();clearTimeout(X),X=setTimeout(()=>{o.filters.search=t,S()},150)}function ot(e){const a=P(o.lockers).filter(l=>g(l.estado)===e);return H(a)}function de(e){const t=E();if(!t)return;const a=g(t.estado),l=ot(a),s=l.findIndex(r=>r.id===t.id);if(s===-1)return;const c=l[s+e];c&&(o.selectedId=c.id,S())}function lt(e){if(e.target.closest("input, select, textarea, button"))return;const t=e.touches[0];t&&(o.touchStart={x:t.clientX,y:t.clientY})}function ue(e){var s;if(!o.touchStart)return;if(!((s=n.root)!=null&&s.classList.contains("panel-open"))){o.touchStart=null;return}const t=e.changedTouches[0];if(!t)return;const a=t.clientX-o.touchStart.x,l=t.clientY-o.touchStart.y;if(o.touchStart=null,Math.abs(l)>60&&Math.abs(l)>Math.abs(a)){const c=n.panelCard?n.panelCard.scrollTop:0;l>0&&c<=0&&Y();return}Math.abs(a)>60&&Math.abs(a)>Math.abs(l)&&(a<0&&de(1),a>0&&de(-1))}function st(){if(!o.virtualization.enabled)return;n.columnsContainer.querySelectorAll(".status-scroll").forEach(t=>{t.addEventListener("scroll",a=>{const l=a.currentTarget.closest(".status-column");if(!l)return;const s=l.dataset.estado,c=Number(l.dataset.total||"0"),r=o.virtualization.limits[s]||V;r>=c||a.currentTarget.scrollTop+a.currentTarget.clientHeight<a.currentTarget.scrollHeight-24||(o.virtualization.limits[s]=r+pe,k())},{passive:!0})})}function ct(){var e,t,a,l,s,c,r,i;n.searchInput.addEventListener("input",nt),n.assignBtn.addEventListener("click",Qe),n.releaseBtn.addEventListener("click",se),n.blockBtn.addEventListener("click",ce),n.panelClose.addEventListener("click",Y),n.panelBackdrop.addEventListener("click",Y),(e=n.localTabs)==null||e.addEventListener("click",Fe),(t=n.viewTabs)==null||t.addEventListener("click",Ge),(a=n.areaGrid)==null||a.addEventListener("click",ie),(l=n.areaListView)==null||l.addEventListener("click",ie),(s=n.panelCard)==null||s.addEventListener("touchstart",lt,{passive:!0}),(c=n.panelCard)==null||c.addEventListener("touchend",ue,{passive:!0}),(r=n.panelCard)==null||r.addEventListener("touchcancel",ue,{passive:!0}),n.columnsContainer.addEventListener("click",Ke),n.columnsContainer.addEventListener("click",je),n.columnsContainer.addEventListener("keydown",Je),n.columnsContainer.addEventListener("pointerdown",We),n.columnsContainer.addEventListener("pointerup",G),n.columnsContainer.addEventListener("pointercancel",G),n.columnsContainer.addEventListener("pointerleave",G),(i=n.legendContainer)==null||i.addEventListener("click",d=>{const u=d.target.closest(".hero-chip[data-estado]");u&&Ye(u.dataset.estado)}),n.quickAssign.addEventListener("click",et),n.quickRelease.addEventListener("click",tt),n.quickBlock.addEventListener("click",at),document.addEventListener("click",d=>{o.quickMenu.open&&n.quickMenu&&!n.quickMenu.contains(d.target)&&(w(),o.panelLocked=!1)}),window.addEventListener("scroll",te,{passive:!0})}async function rt(e=!1){h("Cargando lockers...","info"),o.loading=!0,o.loadingColumns=new Set,k();const t=await ke();if(!t){o.lockers=[],o.loading=!1,N(),y(o.lockers),v(o.lockers),D(),o.selectedId=null,S(),h("Supabase no disponible. Sin datos.","warn");return}const{data:a,error:l}=await t.from("lockers").select("*").order("codigo",{ascending:!0});if(l){console.error(l),o.lockers=[],o.loading=!1,N(),y(o.lockers),v(o.lockers),D(),o.selectedId=null,S(),h("No se pudo cargar lockers.","warn");return}const s=Array.isArray(a)?a:[];s.length?(o.lockers=s,o.loading=!1,(!o.channel||e)&&dt(t),h("Datos actualizados.","success")):(o.lockers=[],o.loading=!1,N(),h("Sin lockers en la base.","warn")),y(o.lockers),v(o.lockers),D(),o.lockers.find(c=>c.id===o.selectedId)||(o.selectedId=null),S()}function it(e){if(!e)return;const{eventType:t}=e,a=e.new,l=e.old;if(t==="INSERT"&&a&&(o.lockers.push(a),F(a.id)),t==="UPDATE"&&a){const s=o.lockers.findIndex(c=>c.id===a.id);s>=0?o.lockers[s]=a:o.lockers.push(a),F(a.id)}t==="DELETE"&&l&&(o.lockers=o.lockers.filter(s=>s.id!==l.id),o.selectedId===l.id&&(o.selectedId=null)),y(o.lockers),v(o.lockers),D(),S()}function N(){if(o.channel){try{o.channel.unsubscribe()}catch{}o.channel=null}}function dt(e){N(),o.channel=e.channel("lockers-realtime").on("postgres_changes",{event:"*",schema:"public",table:"lockers"},t=>it(t)).subscribe(t=>{t==="SUBSCRIBED"&&h("Canal en tiempo real activo.","success")})}function ut(){o.active=!1,N()}function ft(e){n={root:e,searchInput:e.querySelector("#lockerSearch"),mapCount:e.querySelector("#lockerMapCount"),columnsContainer:e.querySelector("#lockerStatusColumns"),selectedHint:e.querySelector("#lockerSelectedHint"),selectedCode:e.querySelector("#lockerSelectedCode"),selectedStateBadge:e.querySelector("#lockerSelectedStateBadge"),selectedStateLabel:e.querySelector("#lockerSelectedStateLabel"),nameInput:e.querySelector("#lockerName"),dateInput:e.querySelector("#lockerDate"),areaSelect:e.querySelector("#lockerGroup"),localSelect:e.querySelector("#lockerLocal"),hasPadlock:e.querySelector("#lockerHasPadlock"),hasDuplicateKey:e.querySelector("#lockerHasDuplicateKey"),assignBtn:e.querySelector("#lockerAssignBtn"),releaseBtn:e.querySelector("#lockerReleaseBtn"),blockBtn:e.querySelector("#lockerBlockBtn"),totalCount:e.querySelector("#lockerTotalCount"),assignedCount:e.querySelector("#lockerAssignedCount"),freeCount:e.querySelector("#lockerFreeCount"),unknownCount:e.querySelector("#lockerUnknownCount"),maintenanceCount:e.querySelector("#lockerMaintenanceCount"),legendContainer:e.querySelector(".hero-meta"),legendChips:Array.from(e.querySelectorAll(".hero-chip[data-estado]")),panel:e.querySelector("#lockerDetailPanel"),panelCard:e.querySelector(".panel-card"),panelTitle:e.querySelector("#lockerPanelTitle"),panelClose:e.querySelector("#lockerPanelClose"),panelBackdrop:e.querySelector("#lockerPanelBackdrop"),toast:e.querySelector("#lockerToast"),quickMenu:e.querySelector("#lockerQuickMenu"),quickAssign:e.querySelector("#lockerQuickAssign"),quickRelease:e.querySelector("#lockerQuickRelease"),quickBlock:e.querySelector("#lockerQuickBlock"),localTabs:e.querySelector("#lockerLocalTabs"),viewTabs:e.querySelector("#lockerViewTabs"),viewToggles:Array.from(e.querySelectorAll(".view-tab[data-view]")),localLabel:e.querySelector("#lockerLocalLabel"),areaGrid:e.querySelector("#lockerAreaGrid"),areaListView:e.querySelector("#lockerAreaListView"),assignmentBoard:e.querySelector("#lockerAssignmentBoard"),stateBoard:e.querySelector("#lockerStateBoard")}}function K(){const e=document.querySelector("[data-lockers-view]");if(!e){o.active&&ut();return}if(e.dataset.lockersInit==="true")return;e.dataset.lockersInit="true",o.active=!0,o.initialLocal=m(Ae()),o.localManual=!1,ft(e);const t=be();o.viewMode=t==="states"?"states":"assignments",Q(),o.collapsedStates=Le(),y(o.lockers),v(o.lockers),S(),ct(),te(),rt()}K(),document.addEventListener("DOMContentLoaded",K),document.addEventListener("partial:loaded",K)})();
