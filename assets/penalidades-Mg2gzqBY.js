const t=e=>document.getElementById(e);let O=null,w=null,y=1,k=20,N=!1,U=0;const x=new Map;let H=!1,E=-1,F=[],G=!1;const Y="penalidades",ne={"CORSEPRI S.A.":["CORSEPRISA","CORSEPRI","CORSEPRI S.A."],"VICMER SECURITY":["VICMER","VICMER SECURITY"]},Z=["penalidades_aplicadas","penalidades_catalogo","penalidades_evidencias","empresas","agentes_seguridad","v_uit_actual"];let l=null,I=!1;const $=window.__PENALIDADES_STATE||(window.__PENALIDADES_STATE={unreachable:!1});function be(){var i,n,o,s,r,c;const e=((o=(n=(i=window.CONFIG)==null?void 0:i.SUPABASE)==null?void 0:n.resolveDbKeyForModule)==null?void 0:o.call(n,Y))||"PENALIDADES",a=((c=(r=(s=window.CONFIG)==null?void 0:s.SUPABASE)==null?void 0:r.getConfig)==null?void 0:c.call(r,e))||{};return{url:a.url,key:a.anonKey}}async function L(){var n,o,s,r,c;if(l)return l;if(I||$.unreachable)return null;const e=(o=(n=window.CONFIG)==null?void 0:n.SUPABASE)==null?void 0:o.listTables;if(typeof e=="function"){const p=((c=(r=(s=window.CONFIG)==null?void 0:s.SUPABASE)==null?void 0:r.resolveDbKeyForModule)==null?void 0:c.call(r,Y))||"PENALIDADES",g=await e(p);return g?(l=Z.reduce((u,d)=>(u[d]=g.has(d),u),{}),l):(I=!0,$.unreachable=!0,null)}const{url:a,key:i}=be();if(!a||!i)return null;try{const p=await fetch(`${a.replace(/\/$/,"")}/rest/v1/`,{headers:{apikey:i,Accept:"application/openapi+json"}});if(!p.ok)return I=!0,$.unreachable=!0,null;const g=await p.json(),u=Object.keys(g.paths||{}),d=new Set(u.map(f=>f.replace(/^\//,"")).filter(f=>f&&f!=="/"&&!f.startsWith("rpc/")));return l=Z.reduce((f,m)=>(f[m]=d.has(m),f),{}),l}catch(p){return console.warn("penalidades: no se pudo leer el esquema de Supabase",p),I=!0,$.unreachable=!0,null}}function P(e,a){const i=t("formPenalidad");i&&i.querySelectorAll("input, select, textarea, button").forEach(s=>{s.id!=="notifyClose"&&(s.disabled=!0)});const n=t("tablaPenalidades");if(n){const s=n.querySelector("tbody");s&&(s.innerHTML="")}const o=t("emptyState");if(o){if(a)o.textContent=a;else{const s=(e||[]).join(", ");o.textContent=s?`No se puede cargar Penalidades. Faltan tablas en Supabase: ${s}.`:"No se puede cargar Penalidades."}o.classList.remove("hidden")}a?v("warn","Supabase no disponible",a):v("warn","Base de datos incompleta","Faltan tablas en Supabase. Revisa la configuracion del proyecto.")}async function he(){const e=await L();if(!e)return P(null,"No se pudo conectar a Supabase. Revisa la URL o tu conexion."),!1;const i=["penalidades_aplicadas"].filter(n=>!e[n]);return i.length?(P(i),!1):!0}function ie(e,a=300){let i=null;return(...n)=>{clearTimeout(i),i=setTimeout(()=>e(...n),a)}}let R=!1;function oe(){R||(document.body.dataset.prevOverflow=document.body.style.overflow||"",document.body.style.overflow="hidden",R=!0)}function se(){R&&(document.body.style.overflow=document.body.dataset.prevOverflow||"",delete document.body.dataset.prevOverflow,R=!1)}function q(e,a=1e4){e&&(e.style.zIndex=String(a))}async function j(){var s,r,c,p,g;const e=t("penalidades-root");if(!e||e.dataset.penalidadesInit==="true"||(e.dataset.penalidadesInit="true",!t("formPenalidad")||!t("tablaPenalidades")))return;if($.unreachable){P(null,"No se pudo conectar a Supabase. Revisa la URL o tu conexion.");return}const a=((c=(r=(s=window.CONFIG)==null?void 0:s.SUPABASE)==null?void 0:r.resolveDbKeyForModule)==null?void 0:c.call(r,Y))||"PENALIDADES",i=(g=(p=window.CONFIG)==null?void 0:p.SUPABASE)==null?void 0:g.waitForClient;if(w=typeof i=="function"?await i(a):null,!w){P(),v("warn","Supabase no disponible","No se pudo inicializar la base de datos para Penalidades.");return}if(!await he())return;await ye(),await _e(),Se(),await S(),t("empresa").addEventListener("change",Le),t("penalidad").addEventListener("change",de),t("formPenalidad").addEventListener("submit",Ne),t("btnCancelar").addEventListener("click",z),t("fechaClear").addEventListener("click",()=>t("fecha").value=""),t("fBuscar").addEventListener("click",()=>{y=1,S()}),t("pageSize").addEventListener("change",()=>{k=parseInt(t("pageSize").value,10)||20,y=1,S()}),t("btnPrev").addEventListener("click",()=>{y>1&&(y--,S())}),t("btnNext").addEventListener("click",()=>{N||(y++,S())});const o=ie(()=>{y=1,S()},300);t("q").addEventListener("input",o),t("q").addEventListener("keydown",u=>{u.key==="Enter"&&u.preventDefault()}),t("fDesdeClear").addEventListener("click",()=>t("fDesde").value=""),t("fHastaClear").addEventListener("click",()=>t("fHasta").value=""),t("tablaPenalidades").addEventListener("click",Te),t("tablaPenalidades").addEventListener("mousedown",u=>{u.target.closest(".eye-badge")&&u.preventDefault()}),t("modalCancel").addEventListener("click",K),t("modalOk").addEventListener("click",qe),t("galleryClose").addEventListener("click",te),t("lightboxClose").addEventListener("click",T),t("lightbox").addEventListener("click",u=>{(u.target.classList.contains("lightbox-backdrop")||u.target.id==="lightbox")&&T()}),t("notifyClose").addEventListener("click",ce),Ie(),document.addEventListener("keydown",u=>{u.key==="Escape"&&(t("modalGallery").classList.contains("hidden")||te(),t("modalDelete").classList.contains("hidden")||K(),t("lightbox").classList.contains("hidden")||T())})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",j):j();document.addEventListener("partial:loaded",j);function we(e){const a=t(e);if(!a)return null;const i=a.options[a.selectedIndex];return((i==null?void 0:i.textContent)||"").trim()||null}function re(e){const a=we(e);return a?ne[a]||[a]:[]}function le(e,a){return a.map(i=>`${e}.eq.${i}`).join(",")}async function ye(){const e=l||await L();if(!e)return;if(e&&!e.empresas){const s=Object.keys(ne).map(r=>`<option value="${r}">${r}</option>`).join("");t("empresa").innerHTML=`<option value="">Seleccionar...</option>${s}`,t("fEmpresa").innerHTML=`<option value="">Todas las empresas</option>${s}`;return}const{data:a,error:i}=await w.from("empresas").select("id,nombre").order("nombre");if(i)return console.error(i);const n=(a||[]).map(o=>`<option value="${o.id}">${o.nombre}</option>`).join("");t("empresa").innerHTML=`<option value="">Seleccionar...</option>${n}`,t("fEmpresa").innerHTML=`<option value="">Todas las empresas</option>${n}`}async function A(e){if(!e||x.has(e))return;const a=l||await L();if(!a||a&&!a.agentes_seguridad)return;let{data:i,error:n}=await w.from("agentes_seguridad").select("id,nombre,dni").eq("empresa_id",e).eq("estado","activo").order("nombre");if(!n&&i&&i.length>0){x.set(e,i);return}const o=re("empresa");if(o.length===0)return;const s=le("empresas.nombre",o),r=await w.from("agentes_seguridad").select("id,nombre,dni,empresas!inner(nombre)").eq("estado","activo").or(s).order("nombre");if(r.error){console.error(r.error);return}x.set(e,r.data||[])}async function _e(){const e=l||await L();if(!e)return;if(e&&!e.penalidades_catalogo){const n=t("penalidad");n&&(n.innerHTML='<option value="">Catálogo no disponible</option>',n.disabled=!0);return}const{data:a,error:i}=await w.from("penalidades_catalogo").select("id,item,categoria,penalidad_nombre,tipo_monto,valor").order("item");if(i)return console.error(i);t("penalidad").innerHTML='<option value="">Seleccionar...</option>'+(a||[]).map(n=>{const o=n.tipo_monto==="PORCENTAJE_UIT"?`${(n.valor*100).toFixed(1)}% UIT`:`${n.valor} UIT`;return`<option value="${n.id}" data-tipo="${n.tipo_monto}" data-valor="${n.valor}" data-cat="${n.categoria}">
      ${n.item}. ${n.penalidad_nombre} (${o})
    </option>`}).join("")}async function Ee(){const e=l||await L();if(!e||e&&!e.v_uit_actual)return null;const{data:a,error:i}=await w.from("v_uit_actual").select("valor").single();return i||!a?null:Number(a.valor)}function Se(){const e=t("agenteSearch"),a=t("taDropdown"),i=t("taList"),n=t("taAddBtn"),o=()=>{a.classList.remove("hidden"),H=!0},s=()=>{a.classList.add("hidden"),H=!1,E=-1},r=()=>{t("agenteId").value="",e.dataset.manual="0"},c=(d,f)=>{if(F=d,i.innerHTML="",!d.length){i.innerHTML=`<div class="ta-empty">Sin resultados para “${C(f)}”.</div>`;return}i.innerHTML=d.map((m,h)=>{const _=C(m.nombre),b=m.dni?`<span class="dni">${C(m.dni)}</span>`:"";return`<div class="ta-item" role="option" data-idx="${h}" tabindex="-1">${_}${b}</div>`}).join(""),Array.from(i.querySelectorAll(".ta-item")).forEach(m=>{m.addEventListener("click",()=>{const h=Number(m.getAttribute("data-idx"));p(h)})})},p=d=>{const f=F[d];f&&(e.value=f.nombre,t("agenteId").value=f.id,e.dataset.manual="0",s())},g=async()=>{const d=e.value.trim().toLowerCase();r();const f=t("empresa").value;if(!f){s();return}if(d.length<2){s();return}await A(f);const h=(x.get(f)||[]).filter(_=>{const b=(_.nombre||"").toLowerCase(),M=(_.dni||"").toLowerCase();return b.includes(d)||M.includes(d)}).slice(0,50);c(h,d),o()};e.addEventListener("input",ie(g,180)),e.addEventListener("focus",()=>{e.value.trim().length>=2&&g()}),e.addEventListener("keydown",d=>{if(!H)return;const f=F.length-1;["ArrowDown","ArrowUp"].includes(d.key)&&d.preventDefault(),d.key==="ArrowDown"?(E=Math.min(f,E+1),u()):d.key==="ArrowUp"?(E=Math.max(0,E-1),u()):d.key==="Enter"?E>=0&&(d.preventDefault(),p(E)):d.key==="Escape"&&s()});function u(){i.querySelectorAll(".ta-item").forEach((f,m)=>{f.classList.toggle("active",m===E),m===E&&f.scrollIntoView({block:"nearest"})})}document.addEventListener("click",d=>{t("agenteTA").contains(d.target)||s()}),n.addEventListener("click",()=>{const d=e.value.trim();if(!d){v("warn","Agente","Escribe un nombre para agregar.");return}t("agenteId").value="",e.dataset.manual="1",e.value=d,s(),v("info","Agente manual","Se usará el nombre ingresado tal cual.")}),t("empresa").addEventListener("change",()=>{e.value="",r(),s()})}function Le(e){const a=e.target.value;a&&A(a).catch(console.error)}async function de(){const e=t("penalidad").selectedOptions[0];if(!e){t("monto").value="";return}const a=Number(e.getAttribute("data-valor")),i=await Ee();if(!i){t("monto").value="";return}t("monto").value=(Math.round(i*a*100)/100).toFixed(2)}function Ce(){const e=t("fEmpresa").value||null,a=t("fLocal").value||null,i=t("fDesde").value?new Date(t("fDesde").value):null,n=t("fHasta").value?new Date(t("fHasta").value):null,o=(t("q").value||"").trim(),s=i?new Date(Date.UTC(i.getFullYear(),i.getMonth(),i.getDate(),0,0,0)).toISOString():null,r=n?new Date(Date.UTC(n.getFullYear(),n.getMonth(),n.getDate(),23,59,59)).toISOString():null;return{empresaId:e,local:a,timeMin:s,timeMax:r,search:o}}function Me(){const e=(y-1)*k,a=e+k-1;return{start:e,end:a}}function ke(){const e=["id","fecha","local","monto_calculado","observaciones","agente_nombre_manual","agente_id","empresa_id","penalidad_id"];return l!=null&&l.empresas&&e.push("empresas (nombre)"),l!=null&&l.agentes_seguridad&&e.push("agentes_seguridad (nombre, dni)"),l!=null&&l.penalidades_catalogo&&e.push("penalidades_catalogo (item, categoria, penalidad_nombre)"),l!=null&&l.penalidades_evidencias&&e.push("penalidades_evidencias (url)"),e.join(`,
      `)}async function S(){const e=l||await L();if(!e)return;if(e&&!e.penalidades_aplicadas){P(["penalidades_aplicadas"]);return}const{empresaId:a,local:i,timeMin:n,timeMax:o,search:s}=Ce(),{start:r,end:c}=Me(),p=!!s,g=ke();let u=w.from("penalidades_aplicadas").select(g).order("fecha",{ascending:!1});a&&(u=u.eq("empresa_id",a)),i&&(u=u.eq("local",i)),n&&(u=u.gte("fecha",n)),o&&(u=u.lte("fecha",o)),p?u=u.limit(1e3):u=u.range(r,c);let{data:d,error:f}=await u;if(f){console.error(f);return}if((d||[]).length===0&&a&&(l!=null&&l.empresas)){const h=re("fEmpresa");if(h.length>0){const _=le("empresas.nombre",h);let b=w.from("penalidades_aplicadas").select(g).order("fecha",{ascending:!1}).or(_);i&&(b=b.eq("local",i)),n&&(b=b.gte("fecha",n)),o&&(b=b.lte("fecha",o)),p?b=b.limit(1e3):b=b.range(r,c);const M=await b;M.error||(d=M.data||[])}}let m=d||[];if(p){const h=s.toLowerCase();m=m.filter(D=>{var W,J;const fe=(l!=null&&l.agentes_seguridad&&((W=D.agentes_seguridad)==null?void 0:W.nombre)||"").toLowerCase(),pe=(D.agente_nombre_manual||"").toLowerCase(),me=(D.observaciones||"").toLowerCase(),ge=(D.local||"").toLowerCase(),ve=(l!=null&&l.empresas?((J=D.empresas)==null?void 0:J.nombre)||"":D.empresa_id||"").toLowerCase();return fe.includes(h)||pe.includes(h)||me.includes(h)||ge.includes(h)||ve.includes(h)}),U=m.length;const _=(y-1)*k,b=_+k,M=m.slice(_,b);Q(M);const ue=b>=U;X(M.length,U,ue);return}Q(m),X(m.length)}function De(e){return`<span class="badge"><span class="dot"></span>${C(e||"")}</span>`}function Q(e){const a=t("tablaPenalidades").querySelector("tbody"),i=t("emptyState");if(e.length===0){a.innerHTML="",i.classList.remove("hidden"),V([]);return}i.classList.add("hidden"),a.innerHTML=e.map(n=>{var g,u,d;const o=(l!=null&&l.empresas?(g=n.empresas)==null?void 0:g.nombre:null)||n.empresa_id||"",s=(l!=null&&l.agentes_seguridad?(u=n.agentes_seguridad)==null?void 0:u.nombre:null)||n.agente_nombre_manual||"(sin nombre)",r=n.penalidades_catalogo?`${n.penalidades_catalogo.item}. ${n.penalidades_catalogo.penalidad_nombre}`:n.penalidad_id?`ID ${n.penalidad_id}`:"",c=((d=n.penalidades_catalogo)==null?void 0:d.categoria)||"",p=Array.isArray(n.penalidades_evidencias)?n.penalidades_evidencias.length:0;return`<tr class="added" data-id="${n.id}">
      <td>${new Date(n.fecha).toLocaleString("es-PE")}</td>
      <td>${o}</td>
      <td>${n.local||""}</td>
      <td>${C(s)}</td>
      <td>${De(c)}&nbsp;${C(r)}</td>
      <td style="text-align:right;">${Number(n.monto_calculado||0).toFixed(2)}</td>
      <td style="text-align:center;">
        <button class="eye-badge" data-eye="${n.id}" title="Ver evidencias">
          ${$e()}
          <span class="eye-count">${p}</span>
        </button>
      </td>
      <td class="actions">
        <button class="icon-btn edit" title="Editar">${xe()}</button>
        <button class="icon-btn del"  title="Eliminar">${Pe()}</button>
      </td>
    </tr>`}).join(""),V(e)}function $e(){return'<svg class="icon-eye"  width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="1.6"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6"/></svg>'}function xe(){return'<svg class="icon-edit" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" stroke="currentColor"/><path d="M20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" stroke="currentColor"/></svg>'}function Pe(){return'<svg class="icon-del"  width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="currentColor"/><path d="M8 6V4h8v2" stroke="currentColor"/><path d="M6 6l1 14h10l1-14" stroke="currentColor"/></svg>'}function X(e,a=null,i=null){a!==null?N=i===!0||y*k>=a:N=e<k,t("pageInfo").textContent=`Página ${y}`,t("btnPrev").disabled=y===1,t("btnNext").disabled=N}function V(e){const a=t("summaryBar"),i=t("sumMontos"),n=t("catBadges");if(!e||e.length===0){a.classList.add("hidden"),i.textContent="S/ 0.00",n.innerHTML="";return}const o=e.reduce((r,c)=>r+(Number(c.monto_calculado)||0),0);i.textContent="S/ "+o.toFixed(2);const s=new Map;e.forEach(r=>{var g;const c=((g=r.penalidades_catalogo)==null?void 0:g.categoria)||"Sin categoria",p=Number(r.monto_calculado)||0;s.set(c,(s.get(c)||0)+p)}),n.innerHTML=Array.from(s.entries()).sort((r,c)=>c[1]-r[1]).map(([r,c])=>`<span class="badge"><span class="dot"></span>${C(r)}: S/ ${c.toFixed(2)}</span>`).join(""),a.classList.remove("hidden")}function C(e){return(e??"").toString().replace(/[&<>"]/g,a=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[a])}function z(){t("formPenalidad").reset(),t("agenteSearch").value="",t("agenteId").value="",t("agenteSearch").dataset.manual="0",t("btnGuardar").textContent="Aplicar penalidad",t("btnCancelar").classList.add("hidden"),t("editId").value="",t("monto").value="",t("previewList").innerHTML=""}function Ie(){const e=t("uploader"),a=t("evidencias"),i=t("previewList"),n=()=>a.click();e.addEventListener("click",n),e.addEventListener("dragover",o=>{o.preventDefault(),e.classList.add("drag")}),e.addEventListener("dragleave",()=>e.classList.remove("drag")),e.addEventListener("drop",o=>{var s,r;o.preventDefault(),e.classList.remove("drag"),(r=(s=o.dataTransfer)==null?void 0:s.files)!=null&&r.length&&(a.files=o.dataTransfer.files,B(a.files,i))}),a.addEventListener("change",()=>B(a.files,i))}function B(e,a){a.innerHTML="",Array.from(e||[]).slice(0,5).forEach(n=>{const o=URL.createObjectURL(n),s=document.createElement("div");s.className="preview-thumb",s.innerHTML=`<img src="${o}" alt="${C(n.name)}" />`,a.appendChild(s)})}async function ee(e){const a=l||await L();if(!a||a&&!a.penalidades_evidencias)return;const i=t("evidencias").files;if(!(!i||i.length===0))for(let n=0;n<Math.min(i.length,5);n++){const o=i[n],s=`${e}/${Date.now()}_${n}_${o.name}`,{error:r}=await w.storage.from("penalidades").upload(s,o);if(r){console.error("Upload error",r);continue}const{data:c}=w.storage.from("penalidades").getPublicUrl(s),p=c==null?void 0:c.publicUrl;p&&await w.from("penalidades_evidencias").insert([{penalidad_aplicada_id:e,url:p}])}}async function Ne(e){if(e.preventDefault(),!G){G=!0;try{const a=l||await L();if(!a){v("warn","Supabase no disponible","No se pudo conectar a la base de datos.");return}if(a&&!a.penalidades_aplicadas){v("error","Error","La tabla penalidades_aplicadas no esta disponible.");return}const i=t("editId").value||null,n=t("empresa").value,o=t("local").value,s=t("penalidad").value,r=t("fecha").value,c=t("observaciones").value||null,p=t("agenteId").value||null,g=(t("agenteSearch").value||"").trim(),d=!p&&!!g?g:null;if(!n||!o||!s||!p&&!d){v("warn","Campos incompletos","Completa Empresa, Local, Penalidad y Agente (o escribe uno nuevo).");return}const f={empresa_id:n,local:o,penalidad_id:s,observaciones:c,fecha:r?new Date(r).toISOString():new Date().toISOString(),agente_id:p,agente_nombre_manual:d};if(i){const{error:m}=await w.from("penalidades_aplicadas").update(f).eq("id",i);if(m){console.error(m),v("error","Error","No se pudo actualizar.");return}await ee(i),z(),await S(),v("success","Actualizado","La penalidad se actualizó correctamente.")}else{const{data:m,error:h}=await w.from("penalidades_aplicadas").insert([f]).select("id").single();if(h||!m){console.error(h),v("error","Error","No se pudo aplicar la penalidad.");return}await ee(m.id),z(),await S(),v("success","Registrado","La penalidad se registró correctamente.")}}finally{G=!1}}}function Te(e){const a=e.target.closest("button");if(!a)return;const i=e.target.closest("tr"),n=i==null?void 0:i.getAttribute("data-id");if(n)if(a.classList.contains("eye-badge")||a.hasAttribute("data-eye")){if(e.preventDefault(),e.stopPropagation(),document.activeElement&&document.activeElement.blur&&document.activeElement.blur(),window.getSelection){const o=window.getSelection();o&&o.removeAllRanges&&o.removeAllRanges()}Ue(n)}else a.classList.contains("edit")?Oe(n):a.classList.contains("del")&&(O=n,Re())}async function Oe(e){const{data:a,error:i}=await w.from("penalidades_aplicadas").select("id, empresa_id, local, agente_id, agente_nombre_manual, penalidad_id, observaciones, fecha").eq("id",e).single();if(i||!a){console.error(i),v("error","Error","No se pudo cargar el registro.");return}if(t("editId").value=a.id,t("empresa").value=a.empresa_id,a.empresa_id){await A(a.empresa_id);const n=x.get(a.empresa_id)||[];if(a.agente_id){const o=n.find(s=>s.id===a.agente_id);o?(t("agenteSearch").value=o.nombre,t("agenteId").value=o.id,t("agenteSearch").dataset.manual="0"):(t("agenteSearch").value="",t("agenteId").value=a.agente_id,t("agenteSearch").dataset.manual="0")}else t("agenteSearch").value=a.agente_nombre_manual||"",t("agenteId").value="",t("agenteSearch").dataset.manual=a.agente_nombre_manual?"1":"0"}t("local").value=a.local||"",t("penalidad").value=a.penalidad_id,await de(),t("observaciones").value=a.observaciones||"",t("fecha").value=a.fecha?new Date(a.fecha).toISOString().slice(0,10):"",t("btnGuardar").textContent="Actualizar",t("btnCancelar").classList.remove("hidden"),v("info","Edición","Estás editando un registro.")}function Re(){q(t("modalDelete")),t("modalDelete").classList.remove("hidden"),oe()}function K(){t("modalDelete").classList.add("hidden"),O=null,se()}async function qe(){if(!O)return;const{error:e}=await w.from("penalidades_aplicadas").delete().eq("id",O);if(e){console.error(e),v("error","Error","No se pudo eliminar.");return}K(),await S(),v("success","Eliminado","El registro fue eliminado.")}async function Ue(e){const a=l||await L();if(!a){v("warn","Supabase no disponible","No se pudo conectar a la base de datos.");return}if(a&&!a.penalidades_evidencias){v("warn","Evidencias","La tabla de evidencias no esta disponible.");return}const{data:i,error:n}=await w.from("penalidades_evidencias").select("url").eq("penalidad_aplicada_id",e).order("subido_en",{ascending:!1});if(n){console.error(n),v("error","Error","No se pudieron cargar las evidencias.");return}const o=t("galleryGrid"),s=i||[];s.length?o.innerHTML=s.map((r,c)=>`<button class="thumb" data-src="${r.url}" aria-label="Ver evidencia ${c+1}">
        <img src="${r.url}" alt="evidencia" />
      </button>`).join(""):o.innerHTML='<div class="muted" style="padding:10px;">No hay evidencias para este registro.</div>',o.querySelectorAll(".thumb").forEach(r=>{r.addEventListener("click",c=>{c.stopPropagation();const p=r.getAttribute("data-src");He(p)})}),q(t("modalGallery")),t("modalGallery").classList.remove("hidden"),oe()}function te(){t("modalGallery").classList.add("hidden"),T(!0),se()}function He(e){q(t("lightbox"),11e3),t("lightboxImg").src=e,t("lightbox").classList.remove("hidden")}function T(e){t("lightbox").classList.add("hidden"),e||(t("lightboxImg").src="")}let ae=null;function v(e="info",a="Info",i=""){const n=t("notifyModal"),o=t("notifyIcon"),s=t("notifyTitle"),r=t("notifyMsg"),c={success:"✅",error:"❌",warn:"⚠️",info:"ℹ️"};o.textContent=c[e]||"ℹ️",s.textContent=a,r.textContent=i||"",q(n,12e3),n.classList.add("hidden"),n.offsetWidth,n.classList.remove("hidden"),n.classList.add("show"),clearTimeout(ae),ae=setTimeout(()=>ce(),2800)}function ce(){const e=t("notifyModal");e.classList.remove("show"),e.classList.add("hidden")}
